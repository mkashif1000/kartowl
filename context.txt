# KartOwl Project Context Document

## Project Overview
KartOwl is a Pakistani e-commerce comparison shopping platform that aggregates products from various marketplaces including Daraz, PriceOye, and Telemart. The application allows users to search for products across multiple platforms simultaneously, compare prices, and find the best deals.

## Architecture
The project consists of two main parts:
1. Backend: Built with NestJS (Node.js framework)
2. Frontend: Built with React and TypeScript using Vite as the build tool

## Backend Details

### Main Files
#### main.ts
```typescript
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  
  // Enable CORS for your frontend
  app.enableCors({
    origin: 'http://localhost:5173', // Your Vite Frontend URL
    methods: 'GET,HEAD,PUT,PATCH,POST,DELETE',
    credentials: true,
  });

  await app.listen(3000);
}
bootstrap();
```

#### app.module.ts
```typescript
// src/app.module.ts
import { Module } from '@nestjs/common';
import { AppController } from './app.controller';
import { DarazService } from './daraz.service';
import { PriceOyeService } from './priceoye.service';
import { TelemartService } from './telemart.service'; // <--- Import

@Module({
  imports: [],
  controllers: [AppController],
  providers: [DarazService, PriceOyeService, TelemartService], // <--- Add to providers
})
export class AppModule {}
```

#### app.controller.ts
```typescript
// src/app.controller.ts
import { Controller, Get, Query } from '@nestjs/common';
import { DarazService } from './daraz.service';
import { PriceOyeService } from './priceoye.service';
import { TelemartService } from './telemart.service';

@Controller('api')
export class AppController {
  constructor(
    private readonly darazService: DarazService,
    private readonly priceOyeService: PriceOyeService,
    private readonly telemartService: TelemartService
  ) {}

  @Get('search')
  async search(@Query('q') query: string) {
    if (!query) return { error: 'Query is required' };
    
    console.log(`üöÄ Starting parallel search for: ${query}`);

    // Run all scrapers at the same time
    const [darazResults, priceOyeResults, telemartResults] = await Promise.all([
      this.darazService.searchProduct(query),
      this.priceOyeService.searchProduct(query),
      this.telemartService.searchProduct(query)
    ]);

    // Merge results
    const allProducts = [...darazResults, ...priceOyeResults, ...telemartResults];
    
    // Optional: Shuffle them so users see a mix of stores, 
    // or sort by price. For now, let's simple merge.
    
    return {
      success: true,
      count: allProducts.length,
      data: allProducts
    };
  }
}
```

#### daraz.service.ts
```typescript
import { Injectable } from '@nestjs/common';
import { chromium } from 'playwright';

@Injectable()
export class DarazService {
  async searchProduct(query: string) {
    const browser = await chromium.launch({ headless: true });
    
    const context = await browser.newContext({
      userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
      viewport: { width: 1366, height: 768 },
    });

    const page = await context.newPage();

    try {
      console.log(`ü¶â KartOwl is hunting for: ${query}`);
      const searchUrl = `https://www.daraz.pk/catalog/?q=${encodeURIComponent(query)}`;
      await page.goto(searchUrl, { waitUntil: 'domcontentloaded', timeout: 45000 });

      // 1. ENHANCED SCROLL FIX: Force images to load with multiple scrolls and waits
      await page.evaluate(async () => {
        // Scroll deeper and slower to catch more lazy items
        window.scrollBy(0, 800);
        await new Promise(r => setTimeout(r, 1000));
        window.scrollBy(0, 800);
        await new Promise(r => setTimeout(r, 1000));
        // Additional scroll for first search reliability
        window.scrollBy(0, 800);
        await new Promise(r => setTimeout(r, 1000));
      });
      
      // 2. EXTRA WAIT FOR IMAGES TO LOAD
      await page.waitForTimeout(2000);

      await page.waitForSelector('[data-qa-locator="product-item"]', { timeout: 15000 });

      const products = await page.evaluate(() => {
        const cards = document.querySelectorAll('[data-qa-locator="product-item"]');
        
        return Array.from(cards).slice(0, 20).map((card: any) => {
          const cardText = card.innerText; // Grab all text for Regex searching

          // --- ENHANCED IMAGE FIX ---
          // PRIORITY CHANGE: Check lazy attributes FIRST, then src.
          const imgEl = card.querySelector('img');
          let image = imgEl?.getAttribute('data-ks-lazyload') || 
                      imgEl?.getAttribute('data-src') || 
                      imgEl?.getAttribute('src') || '';
          
          // Retry mechanism for missing images on first search
          // Note: We can't use await inside page.evaluate, so we'll rely on the extra wait time before
          
          if (image) {
             image = image.replace(/_\d+x\d+.*$/, '').replace(/_.webp$/, '');
          }

          // --- PRICE FIX (Enhanced Strategy) ---
          // Instead of fragile classes, we'll extract prices directly from HTML elements
          let currentPrice = 0;
          let originalPrice = 0;

          // Find Current Price (usually in a span that's not inside <del>)
          const priceElements = card.querySelectorAll('span');
          for (const el of priceElements) {
            // Skip elements inside <del> tags (those are original prices)
            if (el.closest('del')) continue;
            
            const text = el.textContent || el.innerText || '';
            if (text.includes('Rs.') && /[\d,]+/.test(text)) {
              currentPrice = parseInt(text.replace(/[^\d]/g, '')) || 0;
              if (currentPrice > 0) break;
            }
          }

          // Find Original Price (inside <del> tags)
          const delEl = card.querySelector('del');
          if (delEl) {
            const delText = delEl.textContent || delEl.innerText || '';
            if (delText.includes('Rs.')) {
              originalPrice = parseInt(delText.replace(/[^\d]/g, '')) || 0;
            }
          }

          // Fallback: If original price not found or is less than current, set to current
          if (!originalPrice || originalPrice < currentPrice) {
            originalPrice = currentPrice;
          }

          // --- REVIEW FIX (Comma Logic) ---
          const reviewsMatch = cardText.match(/\((\d+[\d,]*)\)/); // Capture digits AND commas
          let reviews = 0;
          if (reviewsMatch) {
             // Remove commas BEFORE parsing. "1,234" -> "1234" -> 1234
             reviews = parseInt(reviewsMatch[1].replace(/,/g, ''));
          }

          // --- METADATA ---
          const titleEl = card.querySelector('a[title]');
          let productUrl = titleEl?.getAttribute('href') || '';
          if (productUrl.startsWith('//')) productUrl = `https:${productUrl}`;
          
          const soldMatch = cardText.match(/(\d+[\d\.]*[kK]?)\s+Sold/i);
          
          // Rating (Star Width Logic) - Keep stars but remove numeric rating
          let hasRating = false;
          const styleElements = card.querySelectorAll('[style*="width"]');
          for (const el of styleElements) {
             const widthStyle = el.getAttribute('style');
             if (widthStyle && widthStyle.includes('%')) {
                const num = parseInt(widthStyle.match(/(\d+)%/)?.[1] || '0');
                if (num > 0 && num <= 100) {
                   hasRating = true;
                   break;
                }
             }
          }

          return {
            id: Math.random().toString(36).substr(2, 9),
            title: titleEl?.getAttribute('title') || 'Unknown Product',
            currentPrice,
            originalPrice,
            discount: originalPrice > currentPrice ? Math.round(((originalPrice - currentPrice) / originalPrice) * 100) : 0,
            image,
            marketplace: 'daraz',
            productUrl,
            hasRating: hasRating, 
            reviews,
            sold: soldMatch ? soldMatch[0] : '0 Sold',
            inStock: true
          };
        });
      });

      return products;

    } catch (error) {
      console.error("‚ùå Scraping failed:", error);
      return [];
    } finally {
      await browser.close();
    }
  }
}
```

#### priceoye.service.ts
```typescript
import { Injectable } from '@nestjs/common';
import { chromium } from 'playwright';

@Injectable()
export class PriceOyeService {
  async searchProduct(query: string) {
    const browser = await chromium.launch({ headless: true });
    
    const context = await browser.newContext({
      userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
      viewport: { width: 1366, height: 768 },
    });

    const page = await context.newPage();

    try {
      console.log(`.owl is checking PriceOye for: ${query}`);
      const searchUrl = `https://priceoye.pk/search?q=${encodeURIComponent(query)}`;
      
      await page.goto(searchUrl, { waitUntil: 'domcontentloaded', timeout: 30000 });

      // 1. Wait for Product List
      // PriceOye uses .product-list for the container
      try {
        await page.waitForSelector('.product-list', { timeout: 10000 });
      } catch (e) {
        console.log("PriceOye: No standard product list found (might be empty result)");
        return [];
      }

      // 2. Extract Data
      const products = await page.evaluate(() => {
        // PriceOye cards are usually inside 'div.product-list' -> 'div.p-item'
        // We select the individual product items
        const cards = document.querySelectorAll('.product-list .p-item, .product-list .productBox');
        
        return Array.from(cards).slice(0, 15).map((card: any) => {
          
          // --- Title & URL ---
          // Usually in a div with class 'p-title' or similar
          const anchor = card.querySelector('a');
          const productUrl = anchor?.href || '';
          
          // Title logic: Try specific class, fallback to image alt
          const titleEl = card.querySelector('.p-title') || card.querySelector('.product-title');
          const title = titleEl?.textContent?.trim() || card.querySelector('img')?.alt || 'Unknown Product';

          // --- Image ---
          // PriceOye uses amp-img for images
          let image = '';
          const ampImgEl = card.querySelector('amp-img');
          if (ampImgEl) {
            image = ampImgEl.getAttribute('src') || '';
            // Handle relative URLs
            if (image && image.startsWith('/')) {
              image = 'https://priceoye.pk' + image;
            }
          } else {
            // Fallback to regular img tag
            const imgEl = card.querySelector('img');
            if (imgEl) {
              image = imgEl.getAttribute('data-src') || imgEl.getAttribute('data-original') || imgEl.src || '';
              // Handle relative URLs
              if (image && image.startsWith('/')) {
                image = 'https://priceoye.pk' + image;
              }
            }
          }

          // --- Price ---
          let currentPrice = 0;
          let originalPrice = 0;
          
          // Current price extraction - look for the main price element
          const currentPriceEl = card.querySelector('.price-box');
          if (currentPriceEl) {
            const currentPriceText = currentPriceEl.textContent || currentPriceEl.innerText || '';
            // Extract numeric values from text like "Rs 169,500"
            const priceMatches = currentPriceText.match(/[\d,]+/g);
            if (priceMatches && priceMatches.length > 0) {
              currentPrice = parseInt(priceMatches[0].replace(/,/g, '')) || 0;
            }
          }

          // Original price extraction - look for crossed out prices or price-diff elements
          const priceDiffEl = card.querySelector('.price-diff');
          if (priceDiffEl) {
            const priceDiffText = priceDiffText.textContent || priceDiffEl.innerText || '';
            // Extract numeric values
            const priceMatches = priceDiffText.match(/[\d,]+/g);
            if (priceMatches && priceMatches.length > 0) {
              originalPrice = parseInt(priceMatches[0].replace(/,/g, '')) || 0;
            }
          }

          // Ensure original price is not less than current price
          if (originalPrice < currentPrice) {
            originalPrice = currentPrice;
          }

          // Calculate discount percentage
          const discount = originalPrice > currentPrice ? Math.round(((originalPrice - currentPrice) / originalPrice) * 100) : 0;

          // --- Rating ---
          let rating = 0;
          // Look for the user rating content div which contains the actual rating
          const ratingContentEl = card.querySelector('.user-rating-content');
          if (ratingContentEl) {
            const ratingText = ratingContentEl.textContent || ratingContentEl.innerText || '';
            const ratingMatch = ratingText.match(/[\d.]+/);
            if (ratingMatch) {
              rating = parseFloat(ratingMatch[0]);
            }
          }
          
          // Fallback: Check for star elements
          if (rating === 0) {
            const starElements = card.querySelectorAll('.stars i, .stars img');
            if (starElements.length > 0) {
              // Count star elements (assuming all are filled if present)
              rating = Math.min(starElements.length, 5); // Max 5 stars
            }
          }
          
          // Final fallback: Default rating
          if (rating === 0) {
            rating = 4.5; // Default rating
          }

          // --- Reviews ---
          let reviews = 0;
          // Look for the rating-h7 bold span which contains the review count
          const reviewCountEl = card.querySelector('span.rating-h7.bold');
          if (reviewCountEl) {
            const reviewsText = reviewCountEl.textContent || reviewCountEl.innerText || '';
            const reviewsMatch = reviewsText.match(/[\d,]+/);
            if (reviewsMatch) {
              reviews = parseInt(reviewsMatch[0].replace(/,/g, '')) || 0;
            }
          }
          
          // Fallback: Look in the user rating box
          if (reviews === 0) {
            const userRatingBox = card.querySelector('.user-rating-box');
            if (userRatingBox) {
              const ratingBoxText = userRatingBox.textContent || userRatingBox.innerText || '';
              const reviewsMatch = ratingBoxText.match(/[\d,]+\s*review/i);
              if (reviewsMatch) {
                const numberMatch = reviewsMatch[0].match(/[\d,]+/);
                if (numberMatch) {
                  reviews = parseInt(numberMatch[0].replace(/,/g, '')) || 0;
                }
              }
            }
          }
          
          // Default reviews if none found
          // Don't use random reviews - if we can't find them, set to a reasonable default
          if (reviews === 0) {
            reviews = 5;
          }

          // Determine stock status
          // According to requirements: When there is no original/non-discounted price, product is out of stock
          // ALSO: When original price equals current price, product is out of stock
          let inStock = true;
          
          // Check if there's no price difference (no discount/original price)
          const hasPriceDifference = !!(priceDiffEl);

          // Check for explicit out-of-stock indicators
          const outOfStockImg = card.querySelector('img[src*="out-of-stock"]') || 
                               card.querySelector('img[alt*="out of stock"]') ||
                               card.querySelector('[class*="out-of-stock"]');
          
          // NEW: Check if original price equals current price (another indicator of out of stock)
          const pricesAreEqual = (originalPrice > 0 && originalPrice === currentPrice);
          
          // According to the requirement: 
          // 1. No original/non-discounted price = out of stock
          // 2. Original price equals current price = out of stock
          // 3. Explicit out-of-stock indicators = out of stock
          if (!hasPriceDifference || outOfStockImg || pricesAreEqual) {
            inStock = false;
          }

          return {
            id: Math.random().toString(36).substr(2, 9),
            title,
            currentPrice,
            originalPrice,
            discount,
            image,
            marketplace: 'priceoye', // Important: This tag tells Frontend to show PriceOye badge
            productUrl,
            rating,
            reviews,
            inStock
          };
        });
      });

      return products;

    } catch (error) {
      console.error("‚ùå PriceOye Scraping failed:", error);
      return [];
    } finally {
      await browser.close();
    }
  }
}
```

#### telemart.service.ts
```typescript
import { Injectable, Logger } from '@nestjs/common';
import { chromium, Browser, Page } from 'playwright';

@Injectable()
export class TelemartService {
  private readonly logger = new Logger(TelemartService.name);
  private readonly BASE_URL = 'https://telemart.pk';

  async searchProduct(query: string) {
    this.logger.log(`Scraping Telemart for: ${query}`);
    let browser: Browser | null = null;

    try {
      browser = await chromium.launch({
        headless: true, // Set to true for production
        args: ['--no-sandbox', '--disable-setuid-sandbox'],
      });

      const context = await browser.newContext({
        userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36',
        viewport: { width: 1280, height: 720 },
      });

      const page = await context.newPage();
      
      // 1. Navigate to Homepage first
      await page.goto(this.BASE_URL, { waitUntil: 'domcontentloaded', timeout: 30000 });
      
      // 2. Find and fill the search box
      await page.waitForSelector('#search-box', { timeout: 10000 });
      await page.fill('#search-box', query);
      await page.press('#search-box', 'Enter');
      
      // 3. Wait for results page to load
      await page.waitForLoadState('networkidle');
      
      // 4. Wait for product links
      try {
        await page.waitForSelector('a[href^="/"][href*="-"], a[href^="https://telemart.pk/"][href*="-"]', { timeout: 15000 });
      } catch (e) {
        this.logger.warn(`No products found on Telemart for "${query}"`);
        return [];
      }

      // 3. Extract Data
      const products = await page.evaluate(() => {
        const items: any[] = [];
        
        // Select all anchor tags that look like product links
        // Based on our inspection, product links start with "/" and contain product names with hyphens
        const productLinks = Array.from(document.querySelectorAll('a[href^="/"][href*="-"], a[href^="https://telemart.pk/"][href*="-"]')).filter((link: any) => {
          const href = link.getAttribute('href');
          // Filter for actual product links (they contain product names, not just categories or navigation)
          return href && 
                 !href.includes('#') && 
                 !href.includes('/cart') && 
                 !href.includes('/account') && 
                 !href.includes('/wishlist') && 
                 href.split('/').length > 1 && 
                 href.split('/')[1].length > 5; // Product URLs have meaningful names
        });

        productLinks.slice(0, 15).forEach((link: any) => {
          try {
            // Get the container element that holds the product info
            const container = link.closest('div') || link.parentElement;
            
            // 1. Title - Look for text content in the link or nearby
            let title = '';
            const titleElement = link.querySelector('h3, h4, h5, h6') || link;
            title = titleElement?.innerText?.trim() || link.innerText.trim() || '';
            
            // Clean up title - remove extra whitespace and promotional text
            title = title.replace(/\s+/g, ' ').trim();
            
            // Remove promotional text like "OFF" percentages and ratings
            title = title.replace(/[0-9]+\s*%\s*OFF/i, '').trim();
            title = title.replace(/[0-9.]+\s*[0-9]*\s*Ratings?\s*&?\s*Reviews?/i, '').trim();
            title = title.replace(/Rs\.\s*[0-9,]+/g, '').trim();
            
            // Clean up extra whitespace again
            title = title.replace(/\s+/g, ' ').trim();
            
            // Skip if title is too short or looks like navigation
            if (title.length < 5 || title.includes('Home') || title.includes('Category')) {
              return;
            }

            // 2. Price - Look for price information near the link
            let currentPrice = 0;
            let originalPrice = 0;
            
            // Look for price elements in the container or link itself
            // First, try to find specific price elements with known patterns
            const priceTextElements = Array.from(container.querySelectorAll('*')).filter((elem: any) => {
              const el = elem as HTMLElement;
              const text = el.innerText || '';
              return (text.includes('Rs') || text.includes('PKR')) && !text.includes('% OFF') && !text.includes('OFF');
            });
            
            // Process each price element
            for (const elem of priceTextElements) {
              const el = elem as HTMLElement;
              const text = el.innerText || '';
              
              // Extract all numbers from the price text
              const matches = text.match(/[\d,]+/g);
              if (matches && matches.length > 0) {
                // Check if this element is a "deleted" price (original price)
                const isDeleted = el.closest('del') !== null;
                
                if (isDeleted) {
                  // This is the original price
                  const price = parseInt(matches[0].replace(/,/g, ''), 10) || 0;
                  if (price > originalPrice) { // Take the highest original price
                    originalPrice = price;
                  }
                } else {
                  // This is likely a current price
                  const price = parseInt(matches[0].replace(/,/g, ''), 10) || 0;
                  if (price > currentPrice && price > 30) { // Take valid current prices > 30
                    currentPrice = price;
                  }
                  
                  // If we have more than one number, the second might be the original price
                  if (matches.length >= 2 && originalPrice === 0) {
                    const secondPrice = parseInt(matches[1].replace(/,/g, ''), 10) || 0;
                    if (secondPrice > originalPrice && secondPrice > 30) {
                      originalPrice = secondPrice;
                    }
                  }
                }
              }
            }
            
            // If we couldn't find price in the container, try the link text
            // But be more careful to avoid picking up discount percentages
            if (currentPrice === 0) {
              const linkText = (link.innerText || '').replace(/\d+\s*%\s*OFF/i, ''); // Remove discount text
              // Look specifically for Rs. amounts
              const rsMatches = linkText.match(/Rs\.\s*[\d,]+/gi);
              if (rsMatches && rsMatches.length > 0) {
                // Extract the numbers from Rs. matches
                const rsNumbers = rsMatches.map(match => {
                  const numberMatch = match.match(/[\d,]+/);
                  return numberMatch ? parseInt(numberMatch[0].replace(/,/g, ''), 10) : 0;
                }).filter(num => num > 0);
                
                if (rsNumbers.length > 0) {
                  rsNumbers.sort((a, b) => a - b); // Sort ascending
                  currentPrice = rsNumbers[0] || 0; // Take the lowest as current price
                  if (rsNumbers.length > 1) {
                    originalPrice = rsNumbers[rsNumbers.length - 1] || 0; // Take the highest as original price
                  }
                }
              } else {
                // Fallback to general number matching
                const priceMatches = linkText.match(/[\d,]+/g);
                if (priceMatches && priceMatches.length >= 1) {
                  // Take the largest numbers as they're likely the prices
                  const numbers = priceMatches.map(match => parseInt(match.replace(/,/g, ''), 10)).filter(num => num > 30); // Filter out small numbers like discount percentages and ratings
                  if (numbers.length > 0) {
                    numbers.sort((a, b) => b - a); // Sort descending
                    currentPrice = numbers[numbers.length - 1] || 0; // Take the smallest of the large numbers as current price
                    if (numbers.length > 1) {
                      originalPrice = numbers[0] || 0; // Take the largest as original price
                    }
                  }
                }
              }
            }
            
            // Make sure originalPrice is not less than currentPrice
            if (originalPrice < currentPrice) {
              originalPrice = currentPrice;
            }

            // 3. Image - Look for images in the container
            let image = '';
            const imgElement = container.querySelector('img');
            if (imgElement) {
              image = imgElement.src || imgElement.getAttribute('data-src') || imgElement.getAttribute('data-original') || '';
            }

            // 4. Discount calculation
            const discount = originalPrice > currentPrice ? Math.round(((originalPrice - currentPrice) / originalPrice) * 100) : 0;

            // 5. Product URL - make sure it's absolute
            let productUrl = link.href || link.getAttribute('href') || '';
            if (productUrl.startsWith('/')) {
              productUrl = 'https://telemart.pk' + productUrl;
            } else if (!productUrl.startsWith('http')) {
              productUrl = 'https://telemart.pk/' + productUrl;
            }

            // 6. Extract rating and reviews
            let rating = 0;
            let reviews = 0;
            
            // Look for text that contains rating information
            const containerText = (container as HTMLElement).innerText || '';
            
            // Extract rating (e.g., "4.00")
            const ratingMatch = containerText.match(/[0-5]\.[0-9]{1,2}/);
            if (ratingMatch) {
              rating = parseFloat(ratingMatch[0]);
            }
            
            // Extract review count - specifically look for numbers in parentheses after ratings
            // Pattern: "4.00 (1)" or "4.50 (15)"
            const reviewCountMatch = containerText.match(/[0-5]\.[0-9]{1,2}\s*\((\d+)\)/);
            if (reviewCountMatch) {
              reviews = parseInt(reviewCountMatch[1], 10);
            } else {
              // Fallback to general pattern
              const generalReviewMatch = containerText.match(/\((\d+)\)|([0-9]+)\s*Reviews?/i);
              if (generalReviewMatch) {
                reviews = parseInt(generalReviewMatch[1] || generalReviewMatch[2], 10);
              } else {
              }
            }
            
            // Default values if not found
            if (rating === 0) rating = 4.5;
            // If we can't find reviews, set to 0 (don't use a default value)
            if (reviews === 0) reviews = 0;
            
            // Only add if we have a title and price
            if (title && currentPrice > 0) {
              items.push({
                id: Math.random().toString(36).substr(2, 9),
                title,
                image,
                currentPrice,
                originalPrice: originalPrice > currentPrice ? originalPrice : 0,
                discount,
                productUrl,
                inStock: true, // Assume in stock unless explicitly marked out
                marketplace: 'telemart',
                rating,
                reviews
              });
            }
          } catch (e) {
            // Skip problematic elements
            console.error('Error processing product element:', e);
          }
        });

        // Deduplicate items based on URL
        return items.filter((v, i, a) => a.findIndex(t => t.productUrl === v.productUrl) === i);
      });

      return products;

    } catch (error) {
      this.logger.error(`Failed to scrape Telemart: ${error.message}`);
      return [];
    } finally {
      if (browser) await browser.close();
    }
  }
}
```

## Frontend Details

### Main Files
#### App.tsx
```typescript
import { Switch, Route } from "wouter";
import { queryClient } from "./lib/queryClient";
import { QueryClientProvider } from "@tanstack/react-query";
import { Toaster } from "@/components/ui/toaster";
import { TooltipProvider } from "@/components/ui/tooltip";
import NotFound from "@/pages/not-found";
import Home from "@/pages/Home";
import BottomNav from "@/components/BottomNav";

function Router() {
  return (
    <Switch>
      <Route path="/" component={Home} />
      <Route component={NotFound} />
    </Switch>
  );
}

function App() {
  return (
    <QueryClientProvider client={queryClient}>
      <TooltipProvider>
        <Toaster />
        <Router />
        <BottomNav />
      </TooltipProvider>
    </QueryClientProvider>
  );
}

export default App;
```

#### Home.tsx
```typescript
import { useState, useEffect } from 'react';
import { Marketplace, Product, ProductDetail } from '@/shared/schema';
import Navbar from '@/components/Navbar';
import ModernHero from '@/components/ModernHero';
import MarketplaceShowcase from '@/components/MarketplaceShowcase';
import VerifiedDealsSection from '@/components/VerifiedDealsSection';
import FilterSidebar from '@/components/FilterSidebar';
import ProfessionalProductCard from '@/components/ProfessionalProductCard';
import EnhancedProductDetailModal from '@/components/EnhancedProductDetailModal';

import Footer from '@/components/Footer';
import { searchProducts } from '@/lib/api';
import { getRandomItems, getRandomItemByCondition } from '@/lib/utils';
import { Button } from '@/components/ui/button';
import { SlidersHorizontal, Loader2 } from 'lucide-react';
import {
  Sheet,
  SheetContent,
  SheetHeader,
  SheetTitle,
  SheetTrigger,
} from "@/components/ui/sheet";

export default function Home() {
  const [searchQuery, setSearchQuery] = useState('');
  const [selectedMarketplaces, setSelectedMarketplaces] = useState<Marketplace[]>([
    'daraz', 'temu', 'aliexpress', 'telemart', 'priceoye'
  ]);
  const [sortBy, setSortBy] = useState('relevance');
  const [showSuspicious, setShowSuspicious] = useState(true);
  const [selectedProductId, setSelectedProductId] = useState<string | null>(null);
  const [hasSearched, setHasSearched] = useState(false);
  const [products, setProducts] = useState<Product[]>([]); // Real products
  const [isLoading, setIsLoading] = useState(false); // Loading state
  
  // Trending/Initial State
  const [trendingProducts, setTrendingProducts] = useState<Product[]>([]);
  const [isTrendingLoading, setIsTrendingLoading] = useState(true);
  
  // New State for Modal
  const [selectedProduct, setSelectedProduct] = useState<ProductDetail | null>(null);

  // ON LOAD: Fetch Random Trending Data
  useEffect(() => {
    const fetchTrending = async () => {
      setIsTrendingLoading(true);
      // Randomly pick a popular category to keep the homepage fresh
      const popularTerms = ['Smart Watches', 'Wireless Earbuds', 'Gaming Headsets', 'Power Banks', 'Bluetooth Speakers'];
      const randomTerm = popularTerms[Math.floor(Math.random() * popularTerms.length)];
      
      console.log(`üî• Fetching trending deals for: ${randomTerm}`);
      try {
        const results = await searchProducts(randomTerm);
        // Shuffle the results to make it look more "random"
        const shuffled = results.sort(() => 0.5 - Math.random());
        setTrendingProducts(shuffled);
      } catch (e) {
        console.error("Failed to load trending", e);
      } finally {
        setIsTrendingLoading(false);
      }
    };

    fetchTrending();
  }, []);

  const handleMarketplaceToggle = (marketplace: Marketplace) => {
    setSelectedMarketplaces(prev =>
      prev.includes(marketplace)
        ? prev.filter(m => m !== marketplace)
        : [...prev, marketplace]
    );
  };

  // The new Search Handler
  const handleSearch = async () => {
    if (!searchQuery.trim()) return;

    setHasSearched(true);
    setIsLoading(true); // Start loading
    setProducts([]);    // Clear old results

    try {
      // 1. Fetch from your NestJS Backend
      const results = await searchProducts(searchQuery);
      setProducts(results);
    } catch (error) {
      console.error("Search failed", error);
    } finally {
      setIsLoading(false); // Stop loading
    }
  };

  const filteredAndSortedProducts = products.filter(product => {
    const matchesMarketplace = selectedMarketplaces.includes(product.marketplace);
    
    // Since we don't have suspicious data from the backend yet, we'll skip this filter
    // In a real implementation, you'd need to add this logic to your backend
    
    return matchesMarketplace;
  }).sort((a, b) => {
    switch (sortBy) {
      case 'price-low':
        return a.currentPrice - b.currentPrice;
      case 'price-high':
        return b.currentPrice - a.currentPrice;
      case 'discount':
        // Since we don't have discount data from the backend yet, we'll sort by original price difference
        return (b.originalPrice || 0) - (a.originalPrice || 0);
      default:
        return 0;
    }
  });

  // Logic to find the best discounted product for the ModernHero featured deal
  const featuredDealProduct = getRandomItemByCondition(trendingProducts, product => 
    product.discount !== undefined && product.discount > 15 && 
    (product.marketplace === 'daraz' || product.marketplace === 'priceoye')
  ) || trendingProducts[0]; // Fallback to first product if no good discount found

  const handleProductClick = (productId: string) => {
    // Look for the product in both the search results and trending products
    const product = [...products, ...trendingProducts].find(p => p.id === productId);
    if (product) {
      // We must enrich the simple product with the fields the Modal expects
      const detailedProduct: ProductDetail = {
        ...product,
        fakeSaleStatus: 'genuine', // Default for now
        description: `Found on ${product.marketplace}. Click 'Go to Store' to view full details.`,
        priceHistory: [], // Empty history for now
        averagePrice: product.currentPrice,
        lowestPrice: product.currentPrice,
        highestPrice: product.originalPrice || product.currentPrice
      };
      setSelectedProduct(detailedProduct);
    }
  };

  return (
    <div className="flex flex-col min-h-screen">
      <Navbar 
        searchQuery={searchQuery}
        onSearchChange={setSearchQuery}
        onSearch={handleSearch}
      />
      
      {!hasSearched && (
        <>
          <ModernHero
            searchQuery={searchQuery}
            onSearchChange={setSearchQuery}
            onSearch={handleSearch}
            featuredDeal={featuredDealProduct}
            isLoading={isTrendingLoading}
          />
          

          <MarketplaceShowcase />
          
          <VerifiedDealsSection onViewDetails={setSelectedProductId} />
        </>
      )}
      
      <main className="flex-1">
        <div className="container mx-auto px-4 py-8">
          {hasSearched && (
            <div className="flex gap-6">
              <aside className="hidden lg:block w-72 flex-shrink-0">
                <div className="sticky top-24">
                  <FilterSidebar
                    selectedMarketplaces={selectedMarketplaces}
                    onMarketplaceToggle={handleMarketplaceToggle}
                    sortBy={sortBy}
                    onSortChange={setSortBy}
                    showSuspicious={showSuspicious}
                    onShowSuspiciousChange={setShowSuspicious}
                  />
                </div>
              </aside>
              
              <div className="flex-1 space-y-6">
                <div className="flex items-center justify-between flex-wrap gap-4">
                  <div>
                    <h2 className="text-3xl font-bold mb-1">
                      {isLoading ? `Searching for "${searchQuery}"...` : searchQuery ? `Results for "${searchQuery}"` : 'All Products'}
                    </h2>
                    <p className="text-muted-foreground">
                      Found <span className="font-semibold text-primary">{filteredAndSortedProducts.length}</span> products across {selectedMarketplaces.length} marketplaces
                    </p>
                  </div>
                  
                  <Sheet>
                    <SheetTrigger asChild>
                      <Button variant="outline" className="lg:hidden" data-testid="button-open-filters">
                        <SlidersHorizontal className="w-4 h-4 mr-2" />
                        Filters & Sort
                      </Button>
                    </SheetTrigger>
                    <SheetContent side="left" className="w-[300px] overflow-y-auto">
                      <SheetHeader>
                        <SheetTitle>Filters & Sort</SheetTitle>
                      </SheetHeader>
                      <div className="mt-4">
                        <FilterSidebar
                          selectedMarketplaces={selectedMarketplaces}
                          onMarketplaceToggle={handleMarketplaceToggle}
                          sortBy={sortBy}
                          onSortChange={setSortBy}
                          showSuspicious={showSuspicious}
                          onShowSuspiciousChange={setShowSuspicious}
                        />
                      </div>
                    </SheetContent>
                  </Sheet>
                </div>
                
                {/* LOADING STATE: Skeleton Cards */}
                {isLoading && (
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                    {[1, 2, 3, 4, 5, 6].map((i) => (
                      <div key={i} className="h-[400px] rounded-2xl bg-slate-200 dark:bg-slate-800 animate-pulse" />
                    ))}
                  </div>
                )}

                {/* REAL DATA STATE */}
                {!isLoading && filteredAndSortedProducts.length > 0 && (
                  <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                    {filteredAndSortedProducts.map(product => (
                      <ProfessionalProductCard 
                        key={product.id} 
                        product={product} 
                        // Pass the click handler
                        onViewDetails={handleProductClick} 
                      />
                    ))}
                  </div>
                )}

                {/* EMPTY STATE */}
                {!isLoading && filteredAndSortedProducts.length === 0 && (
                  <div className="text-center py-20">
                    <div className="text-6xl mb-4">üîç</div>
                    <h3 className="text-2xl font-bold mb-2">No products found</h3>
                    <p className="text-muted-foreground mb-6">
                      Try adjusting your filters or search for something else
                    </p>
                    <Button onClick={() => {
                      setSearchQuery('');
                      setHasSearched(false);
                    }}>
                      Back to Home
                    </Button>
                  </div>
                )}
              </div>
            </div>
          )}
          
          {!hasSearched && (
            <section id="deals" className="py-12">
              <div className="text-center mb-12">
                <h2 className="text-3xl md:text-4xl font-bold mb-4">
                  <span className="bg-gradient-to-r from-primary to-chart-3 bg-clip-text text-transparent">
                    Trending Deals
                  </span>
                </h2>
                <p className="text-lg text-muted-foreground">Popular products with the best prices right now</p>
              </div>
              
              {isTrendingLoading ? (
                // Skeleton Loader
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                   {[...Array(8)].map((_, i) => (
                     <div key={i} className="h-[350px] bg-white rounded-2xl animate-pulse" />
                   ))}
                </div>
              ) : (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                  {/* Show top 20 random products */}
                  {getRandomItems(trendingProducts, 20).map(product => (
                    <ProfessionalProductCard
                      key={product.id}
                      product={product}
                      onViewDetails={handleProductClick}
                    />
                  ))}
                </div>
              )}
            </section>
          )}
        </div>
      </main>
      
      <Footer />
      
      {/* The Pop-up Page (Modal) */}
      <EnhancedProductDetailModal
        product={selectedProduct}
        open={selectedProduct !== null}
        onOpenChange={(open) => !open && setSelectedProduct(null)}
      />
    </div>
  );
}
```

#### api.ts
```typescript
import { Product } from "@shared/schema";

const BACKEND_URL = "http://localhost:3000/api";

export const searchProducts = async (query: string): Promise<Product[]> => {
  try {
    const response = await fetch(`${BACKEND_URL}/search?q=${encodeURIComponent(query)}`);
    
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }

    const json = await response.json();
    
    if (json.success && Array.isArray(json.data)) {
      return json.data;
    }
    
    return [];
  } catch (error) {
    console.error("API Error:", error);
    return []; // Return empty array on error so app doesn't crash
  }
};
```

#### schema.ts
```typescript
export type Marketplace = 'daraz' | 'temu' | 'aliexpress' | 'telemart' | 'priceoye';

// Add or update the Product interface
export type Product = {
  id: string;
  title: string;
  image: string;
  marketplace: 'daraz' | 'temu' | 'aliexpress' | 'telemart' | 'priceoye';
  currentPrice: number;
  originalPrice?: number;
  discount?: number;
  rating?: number;
  reviews?: number;
  sold?: string; // Added sold property
  inStock: boolean;
  productUrl: string; // Renamed from affiliateLink to match backend
}

export type PriceHistory = {
  date: string;
  price: number;
  marketplace: Marketplace;
};

export type FakeSaleStatus = 'genuine' | 'fair' | 'suspicious';

export type ProductDetail = Product & {
  description?: string;
  priceHistory: PriceHistory[];
  fakeSaleStatus: FakeSaleStatus;
  averagePrice: number;
  lowestPrice: number;
  highestPrice: number;
};
```

#### ProfessionalProductCard.tsx
```typescript
import { Product } from '@shared/schema';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { TrendingDown, Star, Eye } from 'lucide-react'; // Changed Icon
import { motion } from 'framer-motion';

export default function ProfessionalProductCard({ product, onViewDetails }: { product: Product, onViewDetails?: (id: string) => void }) {
  const discountAmount = product.originalPrice ? product.originalPrice - product.currentPrice : 0;

  return (
    <motion.div 
      whileHover={{ y: -5 }}
      //ISSUE #3 FIX: Clicking anywhere opens the Modal (onViewDetails)
      onClick={() => onViewDetails && onViewDetails(product.id)}
      className="group relative bg-white dark:bg-slate-900 rounded-2xl shadow-sm hover:shadow-glow transition-all duration-300 border border-slate-100 dark:border-slate-800 overflow-hidden flex flex-col h-full cursor-pointer"
    >
      <div className="absolute top-3 left-3 z-20">
        <Badge variant="secondary" className="backdrop-blur-md bg-white/90 text-slate-800 font-bold shadow-sm">
          {product.marketplace}
        </Badge>
      </div>

      <div className="relative aspect-[4/3] overflow-hidden bg-white p-6 flex items-center justify-center">
        <img 
          src={product.image} 
          alt={product.title}
          className="w-full h-full object-contain group-hover:scale-105 transition-transform duration-500"
        />
        {/* Hover Overlay */}
        <div className="absolute inset-0 bg-black/5 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
             <Button size="sm" className="rounded-full bg-white text-black shadow-lg">
                <Eye className="w-4 h-4 mr-2" /> Quick View
             </Button>
        </div>
      </div>

      <div className="p-4 flex flex-col flex-1 gap-2">
        <div className="flex items-center gap-1 text-xs font-medium text-slate-500">
          <Star className="w-3.5 h-3.5 fill-amber-400 text-amber-400" />
          <span>{product.rating}</span>
          <span className="text-slate-300">‚Ä¢</span>
          <span>{product.reviews} reviews</span>
          {/*ISSUE #5 FIX: Show Sold Count */}
          {product.sold && (
            <>
              <span className="text-slate-300">‚Ä¢</span>
              <span>{product.sold} sold</span>
            </>
          )}
        </div>

        <h3 className="font-bold text-slate-800 dark:text-slate-100 text-sm leading-tight line-clamp-2 min-h-[2.5rem]">
          {product.title}
        </h3>

        <div className="mt-auto pt-3 flex items-end justify-between">
          <div>
            <div className="flex items-baseline gap-2">
              <span className="text-xl font-extrabold text-brand-purple">
                ‚Ç®{product.currentPrice.toLocaleString()}
              </span>
              {product.originalPrice && product.originalPrice > product.currentPrice && (
                <span className="text-xs text-slate-400 line-through decoration-slate-400/50">
                  ‚Ç®{product.originalPrice.toLocaleString()}
                </span>
              )}
            </div>
          </div>
          
          {/*ISSUE #2 FIX: Removed ShoppingCart Button */}
        </div>
      </div>
    </motion.div>
  );
}
```

#### EnhancedProductDetailModal.tsx
```typescript
import { ProductDetail } from '@shared/schema';
import {
  Dialog,
  DialogContent,
} from "@/components/ui/dialog";
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Separator } from '@/components/ui/separator';
import { CheckCircle2, Clock, Share2, ExternalLink, TrendingUp } from 'lucide-react';
import PriceHistoryChart from './PriceHistoryChart';

interface EnhancedProductDetailModalProps {
  product: ProductDetail | null;
  open: boolean;
  onOpenChange: (open: boolean) => void;
}

export default function EnhancedProductDetailModal({ product, open, onOpenChange }: EnhancedProductDetailModalProps) {
  if (!product) return null;

  const discountAmount = product.originalPrice 
    ? product.originalPrice - product.currentPrice 
    : 0;

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-5xl p-0 overflow-hidden bg-white dark:bg-slate-950 border-none shadow-2xl">
        <div className="flex flex-col md:flex-row h-[90vh] md:h-[80vh]">
          
          {/* COLUMN 1: Visuals & History (Scrollable) */}
          <div className="flex-1 overflow-y-auto bg-slate-50 dark:bg-slate-900/50 p-6 md:p-10 scrollbar-hide">
            <div className="bg-white dark:bg-slate-900 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-800 p-8 mb-8 flex items-center justify-center">
              <img 
                src={product.image} 
                alt={product.title}
                className="max-h-[300px] object-contain mix-blend-multiply dark:mix-blend-normal"
              />
            </div>

            {/* Trust Indicators */}
            <div className="grid grid-cols-2 gap-4 mb-8">
              <div className="bg-white dark:bg-slate-900 p-4 rounded-xl border border-slate-100 shadow-sm">
                <div className="text-slate-500 text-xs mb-1">Lowest Price (30d)</div>
                <div className="font-mono font-bold text-lg text-slate-900 dark:text-white">
                  ‚Ç®{product.lowestPrice.toLocaleString()}
                </div>
              </div>
              <div className="bg-white dark:bg-slate-900 p-4 rounded-xl border border-slate-100 shadow-sm">
                <div className="text-slate-500 text-xs mb-1">Real Sale Status</div>
                <Badge variant={product.fakeSaleStatus === 'genuine' ? 'default' : 'destructive'} className="mt-1">
                  {product.fakeSaleStatus.toUpperCase()}
                </Badge>
              </div>
            </div>

            <div className="prose dark:prose-invert max-w-none">
              <h3 className="text-sm font-bold uppercase tracking-wider text-slate-400 mb-4">Analysis</h3>
              <PriceHistoryChart 
                priceHistory={product.priceHistory}
                currentPrice={product.currentPrice}
                averagePrice={product.averagePrice}
                lowestPrice={product.lowestPrice}
                highestPrice={product.highestPrice}
              />
              <p className="text-sm text-slate-600 leading-relaxed mt-6">
                {product.description}
              </p>
            </div>
          </div>

          {/* COLUMN 2: The "Buy Box" (Sticky/Fixed on Desktop) */}
          <div className="w-full md:w-[400px] bg-white dark:bg-slate-950 p-6 md:p-8 border-l border-slate-100 dark:border-slate-800 flex flex-col z-20 shadow-[-20px_0_40px_-10px_rgba(0,0,0,0.05)]">
            
            {/* Header Info */}
            <div className="mb-auto">
              <div className="flex items-center justify-between mb-4">
                <Badge variant="outline" className="border-slate-200 text-slate-500">
                  {product.marketplace}
                </Badge>
                <div className="flex gap-2">
                  <Button size="icon" variant="ghost" className="h-8 w-8 rounded-full">
                    <Share2 className="w-4 h-4" />
                  </Button>
                </div>
              </div>

              <h2 className="text-2xl font-bold text-slate-900 dark:text-white leading-tight mb-2">
                {product.title}
              </h2>
              
              {/* Rating Snippet */}
              <div className="flex items-center gap-2 mb-6">
                <div className="flex text-amber-400">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ</div>
                <span className="text-sm text-slate-400">({product.reviews} verified reviews)</span>
              </div>
            </div>

            {/* Pricing & CTA - The "Money" Area */}
            <div className="space-y-6 mt-6">
              <Separator />
              
              <div>
                <div className="flex items-end gap-3 mb-1">
                  <span className="text-4xl font-extrabold text-brand-purple tracking-tight">
                    ‚Ç®{product.currentPrice.toLocaleString()}
                  </span>
                  {product.originalPrice && (
                    <span className="text-lg text-slate-400 line-through mb-1">
                      {product.originalPrice.toLocaleString()}
                    </span>
                  )}
                </div>
                {product.discount && (
                  <span className="text-green-600 font-medium text-sm flex items-center gap-1">
                    <TrendingUp className="w-4 h-4" />
                    Lowest price in 30 days
                  </span>
                )}
              </div>

              <div className="space-y-3">
                <Button 
                  className="w-full h-14 text-lg bg-slate-900 hover:bg-brand-purple text-white shadow-xl shadow-brand-purple/20 transition-all duration-300 rounded-xl"
                  onClick={() => window.open(product.productUrl, '_blank')}
                >
                  Go to Store <ExternalLink className="ml-2 w-5 h-5" />
                </Button>
                
                <div className="flex items-center justify-center gap-2 text-xs text-slate-400">
                  <CheckCircle2 className="w-3 h-3 text-green-500" />
                  <span>Stock Updated: <span className="font-medium text-slate-600">Just now</span></span>
                </div>
              </div>
            </div>

          </div>
        </div>
      </DialogContent>
    </Dialog>
  );
}
```

#### PriceHistoryChart.tsx
```typescript
import { PriceHistory } from '@shared/schema';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend } from 'recharts';

interface PriceHistoryChartProps {
  priceHistory: PriceHistory[];
  currentPrice: number;
  averagePrice: number;
  lowestPrice: number;
  highestPrice: number;
}

export default function PriceHistoryChart({
  priceHistory,
  currentPrice,
  averagePrice,
  lowestPrice,
  highestPrice
}: PriceHistoryChartProps) {
  const chartData = priceHistory.map(item => ({
    date: new Date(item.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
    price: item.price,
    average: averagePrice
  }));

  return (
    <Card data-testid="card-price-history">
      <CardHeader>
        <CardTitle>Price History (Last 3 Months)</CardTitle>
      </CardHeader>
      <CardContent>
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <div>
            <p className="text-sm text-muted-foreground">Current</p>
            <p className="text-xl font-bold font-mono">‚Ç®{currentPrice.toLocaleString()}</p>
          </div>
          <div>
            <p className="text-sm text-muted-foreground">Average</p>
            <p className="text-xl font-bold font-mono">‚Ç®{averagePrice.toLocaleString()}</p>
          </div>
          <div>
            <p className="text-sm text-muted-foreground">Lowest</p>
            <p className="text-xl font-bold font-mono text-green-600">‚Ç®{lowestPrice.toLocaleString()}</p>
          </div>
          <div>
            <p className="text-sm text-muted-foreground">Highest</p>
            <p className="text-xl font-bold font-mono text-destructive">‚Ç®{highestPrice.toLocaleString()}</p>
          </div>
        </div>
        
        <div className="h-[300px]">
          <ResponsiveContainer width="100%" height="100%">
            <LineChart data={chartData}>
              <CartesianGrid strokeDasharray="3 3" className="stroke-border" />
              <XAxis 
                dataKey="date" 
                tick={{ fontSize: 12 }}
                className="text-muted-foreground"
              />
              <YAxis 
                tick={{ fontSize: 12 }}
                className="text-muted-foreground"
                tickFormatter={(value) => `‚Ç®${(value / 1000).toFixed(0)}k`}
              />
              <Tooltip 
                contentStyle={{ 
                  backgroundColor: 'hsl(var(--popover))',
                  border: '1px solid hsl(var(--popover-border))',
                  borderRadius: '6px'
                }}
                formatter={(value: number) => [`‚Ç®${value.toLocaleString()}`, 'Price']}
              />
              <Legend />
              <Line 
                type="monotone" 
                dataKey="price" 
                stroke="hsl(var(--primary))" 
                strokeWidth={2}
                dot={{ r: 3 }}
                activeDot={{ r: 5 }}
                name="Price"
              />
              <Line 
                type="monotone" 
                dataKey="average" 
                stroke="hsl(var(--muted-foreground))" 
                strokeWidth={2}
                strokeDasharray="5 5"
                dot={false}
                name="Average"
              />
            </LineChart>
          </ResponsiveContainer>
        </div>
      </CardContent>
    </Card>
  );
}
```

#### Navbar.tsx
```typescript
import { Search, Menu, ShoppingBag, TrendingDown } from 'lucide-react';
import { Input } from './ui/input';
import { Button } from './ui/button';
import { Link } from 'wouter';
import {
  Sheet,
  SheetContent,
  SheetTrigger,
} from "./ui/sheet";
import { useState } from 'react';

interface NavbarProps {
  searchQuery?: string;
  onSearchChange?: (query: string) => void;
  onSearch?: () => void;
}

export default function Navbar({ searchQuery = '', onSearchChange, onSearch }: NavbarProps) {
  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
  
  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    onSearch?.();
  };

  const navLinks = [
    { href: '/', label: 'Home', icon: ShoppingBag },
    { href: '#deals', label: 'Hot Deals', icon: TrendingDown },
  ];

  return (
    <header className="sticky top-0 z-50 border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60">
      <div className="container mx-auto px-4">
        <div className="flex items-center gap-4 h-16">
          {/* Logo */}
          <div 
            className="flex items-center hover-elevate px-3 py-2 rounded-md -ml-3 cursor-pointer"
            onClick={() => window.location.reload()}
            data-testid="link-home"
          >
            <img 
              src="/src/assets/kartowl-logo.png" 
              alt="KartOwl Logo" 
              className="h-10 w-auto"
            />
          </div>
          
          {/* Desktop Navigation */}
          <nav className="hidden md:flex items-center gap-1 ml-4">
            {navLinks.map((link) => {
              const Icon = link.icon;
              return link.href === '/' ? (
                <div 
                  key={link.href}
                  className="flex items-center gap-2 px-4 py-2 rounded-md hover-elevate text-sm font-medium cursor-pointer"
                  onClick={() => window.location.reload()}
                >
                  <Icon className="w-4 h-4" />
                  {link.label}
                </div>
              ) : link.href === '#deals' ? (
                <div
                  key={link.href}
                  className="flex items-center gap-2 px-4 py-2 rounded-md hover-elevate text-sm font-medium cursor-pointer"
                  onClick={() => {
                    window.location.hash = '';
                    setTimeout(() => {
                      const element = document.getElementById('deals');
                      if (element) {
                        element.scrollIntoView({ behavior: 'smooth' });
                      }
                    }, 10);
                  }}
                >
                  <Icon className="w-4 h-4" />
                  {link.label}
                </div>
              ) : (
                <Link key={link.href} href={link.href}>
                  <div className="flex items-center gap-2 px-4 py-2 rounded-md hover-elevate text-sm font-medium cursor-pointer">
                    <Icon className="w-4 h-4" />
                    {link.label}
                  </div>
                </Link>
              );
            })}
          </nav>
          
          <div className="flex items-center gap-2 ml-auto">
            {/* Search Bar */}
            <form onSubmit={handleSubmit} className="flex-1 max-w-2xl hidden md:block">
              <div className="relative">
                <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4" />
                <Input
                  type="search"
                  placeholder="Search products across all marketplaces..."
                  value={searchQuery}
                  onChange={(e) => onSearchChange?.(e.target.value)}
                  className="pl-10 pr-4 h-10 bg-muted/50"
                  data-testid="input-navbar-search"
                />
              </div>
            </form>
            
            {/* Desktop Search Button */}
            <Button 
              onClick={onSearch}
              className="hidden md:flex"
              data-testid="button-navbar-search"
            >
              <Search className="w-4 h-4 mr-2" />
              Search
            </Button>
            
            {/* Mobile Menu */}
            <Sheet open={mobileMenuOpen} onOpenChange={setMobileMenuOpen}>
              <SheetTrigger asChild>
                <Button variant="ghost" size="icon" className="md:hidden" data-testid="button-mobile-menu">
                  <Menu className="w-5 h-5" />
                </Button>
              </SheetTrigger>
              <SheetContent side="left" className="w-[300px] sm:w-[400px]">
                <div className="flex flex-col gap-4 mt-8">
                  <form onSubmit={handleSubmit} className="mb-4">
                    <div className="relative">
                      <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4" />
                      <Input
                        type="search"
                        placeholder="Search..."
                        value={searchQuery}
                        onChange={(e) => onSearchChange?.(e.target.value)}
                        className="pl-10"
                      />
                    </div>
                    <Button className="w-full mt-2" type="submit">
                      Search
                    </Button>
                  </form>
                  
                  <nav className="flex flex-col gap-2">
                    {navLinks.map((link) => {
                      const Icon = link.icon;
                      return link.href === '/' ? (
                        <div 
                          key={link.href}
                          className="flex items-center gap-3 px-4 py-3 rounded-md hover-elevate text-base font-medium cursor-pointer"
                          onClick={() => {
                            setMobileMenuOpen(false);
                            window.location.reload();
                          }}
                        >
                          <Icon className="w-5 h-5" />
                          {link.label}
                        </div>
                      ) : link.href === '#deals' ? (
                        <div
                          key={link.href}
                          className="flex items-center gap-3 px-4 py-3 rounded-md hover-elevate text-base font-medium cursor-pointer"
                          onClick={() => {
                            setMobileMenuOpen(false);
                            window.location.hash = '';
                            setTimeout(() => {
                              const element = document.getElementById('deals');
                              if (element) {
                                element.scrollIntoView({ behavior: 'smooth' });
                              }
                            }, 10);
                          }}
                        >
                          <Icon className="w-5 h-5" />
                          {link.label}
                        </div>
                      ) : (
                        <Link key={link.href} href={link.href}>
                          <div 
                            className="flex items-center gap-3 px-4 py-3 rounded-md hover-elevate text-base font-medium cursor-pointer"
                            onClick={() => setMobileMenuOpen(false)}
                          >
                            <Icon className="w-5 h-5" />
                            {link.label}
                          </div>
                        </Link>
                      );
                    })}
                  </nav>
                </div>
              </SheetContent>
            </Sheet>
          </div>
        </div>
      </div>
    </header>
  );
}
```

#### ModernHero.tsx
```typescript
import { Search, TrendingUp, ShieldCheck, Loader2 } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Badge } from '@/components/ui/badge';
import { motion } from 'framer-motion';
import { Product } from '@shared/schema';

interface ModernHeroProps {
  searchQuery?: string;
  onSearchChange?: (query: string) => void;
  onSearch?: () => void;
  featuredDeal?: Product | null;
  isLoading?: boolean;
}

export default function ModernHero({ searchQuery = '', onSearchChange, onSearch, featuredDeal, isLoading }: ModernHeroProps) {
  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    onSearch?.();
  };

  return (
    <section className="relative overflow-hidden pt-20 pb-32 lg:pt-32 lg:pb-40">
      {/* Background Gradients */}
      <div className="absolute top-0 -left-4 w-96 h-96 bg-brand-purple/20 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-blob" />
      <div className="absolute top-0 -right-4 w-96 h-96 bg-brand-teal/20 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-blob animation-delay-2000" />

      <div className="container mx-auto px-4 relative z-10">
        <div className="flex flex-col lg:flex-row items-center gap-12 lg:gap-20">
          
          {/* Left Column: Content */}
          <div className="flex-1 text-center lg:text-left space-y-8">
            <motion.div 
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.5 }}
            >
              <Badge variant="outline" className="px-4 py-1 border-brand-purple/30 text-brand-purple bg-brand-purple/5 mb-6 rounded-full">
                <ShieldCheck className="w-3.5 h-3.5 mr-2" />
                Trusted by 50,000+ Pakistani Shoppers
              </Badge>
              
              <h1 className="text-4xl lg:text-7xl font-bold tracking-tight text-slate-900 dark:text-white leading-[1.1]">
                Stop Overpaying. <br />
                <span className="text-transparent bg-clip-text bg-gradient-to-r from-brand-purple to-brand-teal">
                  Start Karting.
                </span>
              </h1>
              
              <p className="text-lg text-slate-600 dark:text-slate-300 max-w-2xl mx-auto lg:mx-0 leading-relaxed">
                KartOwl scans Daraz, PriceOye, and AliExpress instantly. We track price history so you never fall for a fake sale again.
              </p>
            </motion.div>

            {/* Search Bar - Floating Glass Effect */}
            <motion.div 
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ delay: 0.2, duration: 0.5 }}
              className="p-2 bg-white/80 dark:bg-slate-800/80 backdrop-blur-xl rounded-2xl shadow-2xl border border-white/20 max-w-xl mx-auto lg:mx-0 flex gap-2"
            >
              <div className="relative flex-1">
                <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5" />
                <Input 
                  className="pl-12 h-14 bg-transparent border-none text-lg placeholder:text-slate-400 focus-visible:ring-0"
                  placeholder="Paste a link or search product..."
                  value={searchQuery}
                  onChange={(e) => onSearchChange?.(e.target.value)}
                  onKeyDown={(e) => e.key === 'Enter' && onSearch?.()}
                />
              </div>
              <Button 
                size="lg" 
                onClick={onSearch}
                className="h-14 px-8 rounded-xl bg-brand-purple hover:bg-brand-purple/90 text-white shadow-lg shadow-brand-purple/25 text-lg font-medium"
              >
                Search
              </Button>
            </motion.div>

            {/* Quick Categories */}
            <div className="flex flex-wrap justify-center lg:justify-start gap-3 text-sm text-slate-500">
              <span className="mr-2">Trending:</span>
              {['Infinix Note 30', 'Airpods Pro', 'Gaming Laptop'].map(tag => (
                <button key={tag} className="hover:text-brand-purple underline decoration-dotted transition-colors">
                  {tag}
                </button>
              ))}
            </div>
          </div>

          {/* Right Column: DYNAMIC PRICE DROP CARD */}
          <motion.div 
            initial={{ opacity: 0, scale: 0.95 }} animate={{ opacity: 1, scale: 1 }} transition={{ duration: 0.8 }}
            className="flex-1 relative hidden lg:block"
          >
            <div className="relative z-10 bg-white dark:bg-slate-900 rounded-3xl p-6 shadow-[0_32px_64px_-12px_rgba(0,0,0,0.14)] border border-slate-100 dark:border-slate-800 transform rotate-[-2deg] hover:rotate-0 transition-transform duration-500 max-w-sm mx-auto">
               
               {isLoading ? (
                 // Loading State for Card
                 <div className="flex flex-col items-center justify-center h-80 space-y-4">
                   <Loader2 className="w-10 h-10 text-brand-purple animate-spin" />
                   <p className="text-sm text-slate-400">Scanning for live drops...</p>
                 </div>
               ) : featuredDeal ? (
                 // REAL DEAL STATE
                 <>
                   <div className="bg-slate-50 rounded-xl h-64 w-full mb-4 overflow-hidden relative group flex items-center justify-center p-4">
                      <img 
                        src={featuredDeal.image} 
                        alt={featuredDeal.title} 
                        className="max-h-full max-w-full object-contain mix-blend-multiply"
                      />
                      <div className="absolute top-4 right-4 bg-brand-teal text-white px-3 py-1 rounded-full text-xs font-bold shadow-lg">
                        -{featuredDeal.discount}%
                      </div>
                      <div className="absolute bottom-4 left-4 bg-white/90 backdrop-blur px-4 py-2 rounded-lg text-brand-purple font-bold flex items-center shadow-lg border border-purple-100">
                        <TrendingUp className="w-4 h-4 mr-2" /> Price Drop Detected
                      </div>
                   </div>
                   
                   <div className="space-y-2">
                     <div className="flex justify-between items-start">
                       <h3 className="font-bold text-slate-800 line-clamp-2 text-lg leading-tight">
                         {featuredDeal.title}
                       </h3>
                     </div>
                     
                     <div className="flex items-end justify-between pt-2">
                       <div>
                         <p className="text-xs text-slate-400 mb-0.5">Found on {featuredDeal.marketplace}</p>
                         <div className="flex items-baseline gap-2">
                           <span className="text-2xl font-extrabold text-brand-purple">
                             ‚Ç®{featuredDeal.currentPrice.toLocaleString()}
                           </span>
                           {featuredDeal.originalPrice && (
                             <span className="text-sm text-slate-400 line-through">
                               {featuredDeal.originalPrice.toLocaleString()}
                             </span>
                           )}
                         </div>
                       </div>
                       <Button size="sm" variant="outline" className="rounded-full" onClick={() => window.open(featuredDeal.productUrl, '_blank')}>
                         View Deal
                       </Button>
                     </div>
                   </div>
                 </>
               ) : (
                 // Empty State (rare)
                 <div className="h-80 flex items-center justify-center text-slate-400">
                   No drops found right now.
                 </div>
               )}
            </div>

            {/* Floating Savings Bubble (Only show if we have savings) */}
            {!isLoading && featuredDeal && featuredDeal.discount! > 0 && (
              <div className="absolute -top-6 -right-6 bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-xl animate-bounce duration-[3000ms] border border-slate-100">
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center text-green-600 font-bold">
                    VS
                  </div>
                  <div>
                    <div className="text-xs text-slate-500">Total Savings</div>
                    <div className="font-bold text-green-600">
                      ‚Ç® {(featuredDeal.originalPrice! - featuredDeal.currentPrice).toLocaleString()}
                    </div>
                  </div>
                </div>
              </div>
            )}
          </motion.div>

        </div>
      </div>
    </section>
  );
}

#### MarketplaceShowcase.tsx
```typescript
import { Card, CardContent } from './ui/card';
import { Badge } from './ui/badge';
import { CheckCircle2 } from 'lucide-react';

interface Marketplace {
  name: string;
  description: string;
  color: string;
  image?: string;
}

const marketplaces: Marketplace[] = [
  {
    name: 'Daraz',
    description: 'Pakistan\'s largest online marketplace',
    color: 'from-black-500 to-black-600',
    image: '/src/assets/daraz-logo.png'
  },
  {
    name: 'OLX',
    description: 'Local classified ads and marketplace',
    color: 'from-black-500 to-black-600',
    image: '/src/assets/olx-logo.png'
  },
  {
    name: 'Telemart',
    description: 'Electronics and gadgets specialist',
    color: 'from-black-500 to-black-600',
    image: '/src/assets/telemart-logo.png'
  },
  {
    name: 'PriceoYe',
    description: 'Best prices on tech products',
    color: 'from-black-500 to-black-600',
    image: '/src/assets/priceoye-logo.png'
  }
];

export default function MarketplaceShowcase() {
  return (
    <section className="py-12 md:py-16 lg:py-24 bg-muted/30">
      <div className="container mx-auto px-4">
        <div className="text-center mb-12">
          <Badge className="mb-4" variant="outline">
            <CheckCircle2 className="w-3 h-3 mr-1" />
            Trusted Marketplaces
          </Badge>
          <h2 className="text-3xl md:text-4xl font-bold mb-4">
            Compare Prices Across 4+ Marketplaces
          </h2>
          <p className="text-lg text-muted-foreground max-w-2xl mx-auto">
            We search all major Pakistani online stores to find you the best deals
          </p>
        </div>
        
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
          {marketplaces.map((marketplace, index) => (
            <Card 
              key={marketplace.name} 
              className="group hover-elevate active-elevate-2 transition-all cursor-pointer overflow-hidden"
              data-testid={`card-marketplace-${marketplace.name.toLowerCase()}`}
              style={{ animationDelay: `${index * 100}ms` }}
            >
              <CardContent className="p-6 text-center space-y-4">
                <div className={`w-16 h-16 mx-auto rounded-full bg-gradient-to-br ${marketplace.color} flex items-center justify-center text-3xl shadow-lg group-hover:scale-110 transition-transform`}>
                  {marketplace.image ? (
                    <img 
                      src={marketplace.image} 
                      alt={`${marketplace.name} Logo`} 
                      className="w-10 h-10 object-contain"
                    />
                  ) : (
                    // Placeholder when no image is provided
                    <div className="text-2xl font-bold text-white">
                      {marketplace.name.charAt(0)}
                    </div>
                  )}
                </div>
                <div>
                  <h3 className="font-bold text-lg mb-1">{marketplace.name}</h3>
                  <p className="text-sm text-muted-foreground">{marketplace.description}</p>
                </div>
              </CardContent>
            </Card>
          ))}
        </div>
        
        <div className="mt-12 text-center">
          <div className="inline-flex items-center gap-2 px-6 py-3 bg-primary/10 rounded-full">
            <CheckCircle2 className="w-5 h-5 text-primary" />
            <span className="font-medium">Real-time price tracking ‚Ä¢ Historical data ‚Ä¢ Fake sale detection</span>
          </div>
        </div>
      </div>
    </section>
  );
}
```
